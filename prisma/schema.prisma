generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?
  password      String?
  role          String         @default("USER")
  image         String?
  phone         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  bankAccount   String?
  bankHolder    String?
  bankName      String?
  inquiries     Inquiry[]
  properties    Property[]
  wishlists     Wishlist[]
  whatsappMessage String?
  
  // === SELLER/AGENT PROFILE ===
  accountType     String   @default("INDIVIDUAL")  // INDIVIDUAL | AGENT | AGENCY
  verified        Boolean  @default(false)          // Verified badge
  bio             String?                            // Deskripsi profil
  company         String?                            // Nama perusahaan (untuk agency)
  photo           String?                            // Foto profil
  
  upgradeRequests AccountUpgradeRequest[]
  
  // === MONETIZATION ===
  listingLimit    Int       @default(1)    // Kuota dasar untuk user baru
  packageExpiry   DateTime?                // Masa berlaku paket (untuk AGENT/AGENCY)
  orders          Order[]
}


model Property {
  id             String             @id @default(cuid())
  title          String
  slug           String?            @unique
  description    String
  price          Decimal
  location       String
  address        String
  bedrooms       Int
  bathrooms      Int
  area           Float
  landArea       Float?
  type           String
  status         String
  images         String
  featured       Boolean            @default(false)
  latitude       Float?
  longitude      Float?
  views          Int                @default(0)
  certificate    String?
  condition      String?
  furnishing     String?
  floors         Int?
  userId         String
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  mapsEmbed      String?
  videoUrl       String?
  virtualTourUrl String?
  inquiries      Inquiry[]
  user           User?              @relation(fields: [userId], references: [id])
  facilities     PropertyFacility[]
  propertyImages PropertyImage[]
  wishlists      Wishlist[]
}

model PropertyImage {
  id         String   @id @default(cuid())
  url        String
  caption    String?
  isPrimary  Boolean  @default(false)
  sortOrder  Int      @default(0)
  propertyId String
  createdAt  DateTime @default(now())
  hash       String?
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Facility {
  id         String             @id @default(cuid())
  name       String             @unique
  icon       String?
  category   String?
  createdAt  DateTime           @default(now())
  properties PropertyFacility[]
}

model PropertyFacility {
  id         String   @id @default(cuid())
  propertyId String
  facilityId String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, facilityId])
}

model Wishlist {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
}

model Inquiry {
  id         String   @id @default(cuid())
  name       String
  email      String
  phone      String?
  message    String
  isRead     Boolean  @default(false)
  isReplied  Boolean  @default(false)
  propertyId String
  userId     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User?    @relation(fields: [userId], references: [id])
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

// Account Type Upgrade Request untuk approval workflow
model AccountUpgradeRequest {
  id              String   @id @default(cuid())
  userId          String
  requestedType   String   // AGENT | AGENCY
  currentType     String   // Biasanya INDIVIDUAL
  reason          String?  // Alasan user upgrade
  status          String   @default("PENDING") // PENDING | APPROVED | REJECTED
  adminNote       String?  // Catatan admin saat approve/reject
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

model ListingPackage {
  id           String   @id @default(cuid())
  name         String
  description  String?
  price        Decimal
  listingLimit Int      // Kuota listing yang diberikan
  durationDays Int      @default(30)
  type         String   @default("SUBSCRIPTION") // SUBSCRIPTION | TOPUP
  createdAt    DateTime @default(now())
  orders       Order[]
}

model Order {
  id          String   @id @default(cuid())
  userId      String
  packageId   String
  amount      Decimal
  status      String   @default("PENDING") // PENDING | PAID | EXPIRED | CANCELLED
  snapToken   String?  // Untuk Midtrans Snap API
  snapUrl     String?  // URL redirect pembayaran
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  package     ListingPackage @relation(fields: [packageId], references: [id])

  @@index([userId])
  @@index([packageId])
  @@index([status])
}
